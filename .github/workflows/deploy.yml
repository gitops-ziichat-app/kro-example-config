name: GitOps Deploy

on:
  workflow_dispatch:  # ðŸ‘ˆ Cho phÃ©p trigger báº±ng tay
    inputs:
      deploy_env:
        description: "Deployment environment (local, staging, production)"
        required: true
        default: "local"

  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Thiáº¿t láº­p environment Ä‘á»™ng náº¿u cÃ³ input, máº·c Ä‘á»‹nh lÃ  'local'
    environment: ${{ github.event.inputs.deploy_env || 'local' }}

    env:
      # LÆ°u biáº¿n deploy_env Ä‘á»ƒ dÃ¹ng bÃªn dÆ°á»›i
      DEPLOY_ENV: ${{ github.event.inputs.deploy_env || 'local' }}
      ENV_FILE_CONTENT: ${{ secrets[format('ENV_FILE_CONTENT_{0}', (github.event.inputs.deploy_env || 'local') ) | upper] }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Write .env to file
        run: |
          echo "$ENV_FILE_CONTENT" > kustomize/overlays/${{ env.DEPLOY_ENV }}/config.env

      - name: Build and Apply Kustomize
        run: |
          cd kustomize/overlays/${{ env.DEPLOY_ENV }}
          kustomize build .
